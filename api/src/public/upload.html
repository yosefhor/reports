<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>העלאת דו"ח</title>
</head>
<body>
<h2>העלה קובץ TXT</h2>

<input type="file" id="fileInput" accept=".txt" required />
<button id="uploadBtn">שלח לעיבוד</button>

<p id="result"></p>

<script>
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const result = document.getElementById('result');

async function refreshAccessToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) throw new Error("אין טוקן רענון");

    const res = await fetch('/auth/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: refreshToken })
    });

    if (!res.ok) throw new Error("Refresh token לא תקין");

    const data = await res.json();
    localStorage.setItem('accessToken', data.accessToken);
    return data.accessToken;
}

async function uploadReport() {
    const file = fileInput.files[0];
    if (!file) {
        result.textContent = "בחר קובץ קודם";
        return;
    }

    let token = localStorage.getItem('accessToken');
    if (!token) {
        result.textContent = "אין טוקן, אנא התחבר קודם";
        return;
    }

    const formData = new FormData();
    formData.append('report', file);

    try {
        let res = await fetch('/reports/upload', {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        // אם access token פג, ננסה לרענן
        if (res.status === 401 || res.status === 403) {
            token = await refreshAccessToken(); // מקבל access token חדש
            res = await fetch('/reports/upload', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
        }

        const data = await res.json();
        result.textContent = JSON.stringify(data);

    } catch (err) {
        result.textContent = "שגיאה: " + err;
    }
}

uploadBtn.addEventListener('click', uploadReport);
</script>
</body>
</html>
